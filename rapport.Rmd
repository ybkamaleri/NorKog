---
title: "Rapport for NorKog"
output:
  pdf_document
date: '`r format(Sys.Date(), "%d %b %Y")`'
---

```{r dataValg, echo=FALSE}
rm(list = ls())

########################
## Valgfrie variabler ##
########################

## Hvilket år skal kombineres? - endres etter behov
yearMix <- 2008:2011

## deling for tekst posisjon i bar figur 1
deltxt <- 80


```




```{r file, echo=FALSE, warnings=FALSE, include=FALSE, message=FALSE}

## henter pakker eller installere om ikke finnes
inspak <- function(pkg){
  nypkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(nypkg))
    install.packages(nypkg, dependencies = TRUE, repos = "http://cran.r-project.org")
}

pakke <- c("data.table", "ggplot2", "directlabels", "grid", "knitr", "kableExtra", "haven")
inspak(pakke)

## Upload libraries
library(data.table)
library(ggplot2)
library(directlabels)
library(knitr)
library(grid)
library(kableExtra)
library(haven) #for å lese .sav fil

############
############
## DATA
filDir <- getwd()
sr01 <- paste0(filDir,"/", "datakilder1.R")
sr02 <- paste0(filDir, "/", "datakilder2.R")
##ifelse(file.exists(sr01), source(sr01), source(sr02))
data <- ifelse(file.exists(sr01), sr01, sr02)
source(data)

#############
## Knitr opt
#############
##lager mappe for å lage figurer
knitr::opts_chunk$set(fig.path = 'figures/nkog-')


###########
## FARGER
###########
ColPoint <- "#FF3333" #farge for point
cols <- c("#C6DBEF", "#4292C6", "#084594") #farge for flere bar
colb <- "#99CCFF" #farge for en søyle
options(digits = 3)
setDT(RegData)
setkey(RegData, SENTER)

###########
## Function
###########

## bytt NA med 0
bNA <- function(DT, na = 0){
  for (j in seq_len(ncol(DT)))
    set(DT,which(is.na(DT[[j]])),j, na) 
}

###############
## Senter navn
################

## Lister av navn for sentrene
sentfil <- paste0(filDir, "/doc/senter.csv")
senter <- data.table::fread(sentfil, header = TRUE, encoding = "Latin-1")
setkey(senter, Senter) #key er senter kode

## Slå sammen senternavn og dataset
Data <- merge(RegData, senter, by.x = "SENTER", by.y = "Senter", all.x = TRUE)

```

# Antall inkluderte per poliklinikk

```{r figAntall, echo=FALSE, message=FALSE, warning=FALSE}
## Antall pasienter per senter
fig00Data <- Data[, .N, by = Navn]
sn <- dim(senter)[1] #antall sentre
NN <- dim(RegData)[1] #antall pasienter 

## Merge
missn <- fig00Data[is.na(N), .N] #antall senter med misssing data
fig01Data <- fig00Data[is.na(N), N := 0] #missing til 0

inkn <- sn - missn #antall senter uten missing data
inkl <- Data[, length(unique(Navn))]

```

Det er `r inkl` poliklinikker inkludert i analysen. [*Her kan det ligge mer tekst om det er ønkelig*]

```{r fig01, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.height = 6}

## Legge til gjennomsnitt hele landet
DTsnitt <- data.table(Navn = "Gjennomsnitt", N = NN / sn)
fig02Data <- rbindlist(list(fig01Data, DTsnitt)) #kombinere gjennomsnitt til datasett

innText <- fig02Data[, pos := ifelse(N < deltxt, 0, 1)]
title <- paste0("Antall inkluderte per senter (N = ", NN, ")")
position = position_dodge(width = .80)
width = .80

ggplot(innText, aes(reorder(Navn, N), N, label = N)) +
  geom_bar(width = width, position = position, stat = "identity", aes(fill = Navn == 'Gjennomsnitt')) +
  geom_text(data = innText[pos == 1], hjust = 1.3, size = 2.5) +
  geom_text(data = innText[pos == 0], hjust = -0.3, size = 2.5) +
  coord_flip() +
  labs(title = title, y = "", x = "") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = cols) + 
  theme(
    plot.title = element_text(size = 10, color = "black"), 
    plot.margin = unit(c(0,2,0.5,0.5), "cm"),
    axis.text.y = element_text(size = 9, color = "black"),
    axis.ticks.y = element_blank(),
    axis.line.x = element_line(size = 0.5),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.y = element_text(size = 9),
    axis.title.x = element_text(size = 9),
    legend.position = "none")

## gg.fig01T <- ggplot_gtable(ggplot_build(gg.fig1))
## gg.fig01T$layout$clip[gg.fig01T$layout$name == "panel"] <- "off"
## grid.draw(gg.fig01T)
```

\pagebreak


# Antall inkluderte per poliklinikk per år

```{r tab01data, echo=FALSE, message=FALSE, warning=FALSE}
## ## Fra først data sett
## Data <- Data[, date_us := as.IDate(DATO_US, format = "%m/%d/%Y")] #konvertere DATO_US til date.format
## Data[, yr := as.integer(format(date_us, "%Y"))] #lage kolone "yr" for år fra DATO_US
## yrNA <- Data[is.na(yr), .N] # Antall DATO_US == NA

#### Gir nytt variablenavn
############################
yr <- "US_AARSTALL"
## Data[, yr := get(yr)]
## yr <- quote(US_AARSTALL)
## Data[, yr := eval(yr)]
setnames(Data, yr, "yr") 

yrNA <- Data[is.na(yr), .N]


###############################
## Slå sammen år til en kolone
###############################
yrmix <- yearMix #slå sammen disse årstallene
yrtab <- paste0(min(yearMix),"-", max(yearMix)) #tekst til tabell
Data[, yr2 := ifelse(yr %in% yrmix, 1000, yr)] #dummy for 2008:2012 er 1000

## Dataset uten NA i DATO_US
Datayr <- Data[, .SD[!is.na(yr)]] #exclude DATO_US == NA

```

Det er `r yrNA` missing data i **US_AARSTALL**. Derfor antallet er ikke lik som i forrige figur

```{r tab01, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

## Antall per senter per år
senNyrNA <- Datayr[, .N, by = .(Navn, yr2)]
## names(senNyrNA)[names(senNyrNA) == "N"] <- "n"
setnames(senNyrNA, "N", "n")
## kovertere til wide
senNyr1 <- dcast(senNyrNA, Navn ~ yr2, value.var = "n")

bNA(DT = senNyr1, na = 0) #bytt all NA til 0

## Antall total per senter
senN <- Datayr[, .N, by = .(Navn)]

## names(senN)[names(senN) == "N"] <- "Total"
setnames(senN, old = "N", new = "Total")


## Kobinere antall per senter og total
tab02 <- merge(senNyr1, senN, by="Navn")

## Antall per år
yearN <- Datayr[, .N, by = .(yr2)]
yearN$Navn <- "Total"
yearN1 <- dcast(yearN, Navn ~ yr2, value.var = "N")
yearN1$Total <- dim(Datayr)[1]

## Tabell
tab02all <- rbind(tab02, yearN1)
## names(tab02all)[names(tab02all) == 1000] <- yrtab #gi col navn
## names(tab02all)[names(tab02all) == "Navn"] <- "Poliklinikk" #col navn Senter
setnames(tab02all, c(1000, "Navn"), c(yrtab, "Poliklinikk"))


## print tabell
rowspec <- dim(tab02all)[1]
kable(tab02all, format = "latex", booktabs = TRUE) %>%
  kable_styling(latex_options = c("repeat_header", "hold_position")) %>%
  row_spec(rowspec, bold = TRUE) 

## knitr::kable(tab02all)

```

\pagebreak

```{r demodata, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

## eksludert senter med mindre enn 20
valgSenter <- senN$Navn[senN$Total > 20] #vector Senter navn med deltaker >20

DataT02 <- Data[Navn %in% valgSenter, ]
dataN <- dim(DataT02)[1]
setkey(DataT02, Navn)

```

# Demografiske variabler, gjennomsnitt per poliklinikk og missing

Poliklinikker med deltaker mindre enn 20 pasienter er eksludert i alle analysene
herfra. Total pasienter som brukes i analysen er **`r dataN`**

```{r tab02data, echo=FALSE, message=FALSE, warning=FALSE}

#OBS! kan lage problem med norske bokstaver

## ## Alder beregn fra år hentes fra DATO_US
## ## rename FØDSELSÅ to "byear" 

## vb01 <- grep("DSELS", colnames(DataT02), fixed = TRUE)#finne index for FØDSELSÅ
## colnames(DataT02)[vb01] <- "byear"
## DataT02[, alder := yr - byear] 
## DataT02[, alder := ifelse(is.na(alder), ALDER_PAS, alder)]
## ageT02 <- DataT02[, mean(alder, na.rm = TRUE), by = Navn]
## names(ageT02)[names(ageT02) == "V1"] <- "Alder"
## ## ageTot <- DataT02[, mean(alder, na.rm = TRUE)] #total mean alder

## Alder
v.alder <- "ALDER"
## DataT02[, alder := get(v.alder)]
setnames(DataT02, v.alder, "alder")
ageT02 <- DataT02[, list(alder = mean(as.numeric(alder), na.rm = TRUE)), by = Navn]


## Kjønn - andel per senter 0 = Kvinne
v.kjonn <- grep("KJONN", colnames(DataT02))

colnames(DataT02)[v.kjonn] <- "kjonn"
## kjonnval <- c("Kvinne", "Mann")
## DataT02$kjonn <- factor(DataT02$kjonn,
##                         levels = c(0, 1),
##                         labels = kjonnval)


v.kjonnmk <- DataT02[, .N, by = Navn] # antall per poliklinikk
v.kjonnk <- DataT02[kjonn == 0, .N, by = Navn] # antall kvinner
setnames(v.kjonnk, "N", "n")
setkey(v.kjonnmk, Navn)
setkey(v.kjonnk, Navn)
kvinne <- v.kjonnk[v.kjonnmk]
kvinne[, kvinne := n / N * 100, by = Navn]
kvinneT02 <- kvinne[, c(1, 4)]


## Sivil status
v.civil <- "SIVILSTA"
setnames(DataT02, v.civil, "sivil") #gir nytt navn

sivil02na <- DataT02[!is.na(sivil), .N, by = Navn]
sivil02ja <- DataT02[sivil == 1, .N, by = Navn]
setnames(sivil02ja, "N", "n")
setkey(sivil02na, Navn)
setkey(sivil02ja, Navn)
sivil02per <- sivil02ja[sivil02na]
sivil02per[, sivil := n / N * 100, by = Navn]
sivilT02 <- sivil02per[, c(1, 4)]

## Utdannelse
## Bytt ÅR_SKOLE til "skoleyr"
v.utdanning <- grep("SKOLEGANG", colnames(DataT02))#finne index for ÅR_SKOLE
colnames(DataT02)[v.utdanning] <- "skoleyr"
DataT02[, skoleyr := as.numeric(skoleyr)]
skoT02 <- DataT02[, list(edu = mean(skoleyr, na.rm = TRUE)), by = Navn]


## Offentlig hjelp NA remove
## Skal NA tatt bort eller bregn som nevner???
##proOffTab <- DataT02[order(OFF_HJEL), list(unique(OFF_HJEL), proHjel = tabulate(OFF_HJEL) / .N + 100), by = Navn]
v.offhjelp <- "OFF_HJEL"
v.offhjelpna <- DataT02[!is.na(get(v.offhjelp)), .N, by = Navn]
v.offhjelpja <- DataT02[get(v.offhjelp) == 1, .N, by = Navn]
colnames(v.offhjelpja) <- c("Navn", "n")
setkey(v.offhjelpna, Navn)
setkey(v.offhjelpja, Navn)
offT02Tab <- v.offhjelpna[v.offhjelpja]
offT02Tab[, off := n / N * 100, by = Navn]
offT02 <- offT02Tab[, c(1, 4)]

## Komparent NA remove
v.komparen <- "KOMPAREN"
v.komparenna <- DataT02[!is.na(get(v.komparen)), .N, by = Navn]
v.komparenja <- DataT02[get(v.komparen) == 1, .N, by = Navn]
colnames(v.komparenja) <- c("Navn", "n")
setkey(v.komparenna, Navn)
setkey(v.komparenja, Navn)
komT02Tab <- v.komparenna[v.komparenja]
komT02Tab[, kom := n / N * 100, by = Navn]
komT02 <- komT02Tab[, c(1, 4)]

## kombinere alle tabellen
listTab <- list(ageT02, skoT02, kvinneT02, sivilT02, offT02, komT02)
tabell01 <- Reduce(function(x, y) x[y], listTab)

## Reorganisere tabellen
tabell01 <- tabell01[, list(Navn, alder, kvinne, edu, sivil, off, kom)]

col.name <- c("Senter", "age", "kjonn", "edu", "civil", "off", "kom")

## bytte col names

colnames(tabell01) <- col.name


##############
### TOTAL
##############

## Mean alder og utdannelse Total
tot01 <-  DataT02[, lapply(.SD, function(x) mean(x, na.rm = TRUE)), .SDcol = c("alder", "skoleyr")]
setnames(tot01, "skoleyr", "edu")

## Andel kvinner
kvinneJa <- DataT02[kjonn == 0, .N]
kvinneAll <- dim(DataT02)[1]
kvinneTot <- kvinneJa / kvinneAll * 100

## Andel gift/samboer
c.All <- DataT02[!is.na(sivil), .N]
c.gift <- DataT02[sivil == 1, .N]
giftTot <- c.gift / c.All * 100

## Andel svarte Ja OFF_HJEL eksludert NA
offAlle <- DataT02[!is.na(get(v.offhjelp)), .N] #OFF_HJEL uten NA
## totOff <- DataT02[, lapply(.SD, function(x) tabulate(x) / offNA * 100), .SDcol = c(v.offhjelp)] #uten NA OFF_HJEL
## enkle løsning
offJa <- DataT02[get(v.offhjelp) == 1, .N]
offTot <- offJa / offAlle * 100

## Andel svarte Ja KOMPAREN eksludert NA
komAlle <- DataT02[!is.na(get(v.komparen)), .N] #KOMPAREN uten NA
## totKom <- DataT02[, lapply(.SD, function(x) tabulate(x) / komNA * 100), .SDcol = c(v.komparen)] #uten NA OFF_HJEL
komJa <- DataT02[get(v.komparen) == 1, .N]
komTot <- komJa / komAlle * 100

## kobinere
tot02 <- data.table(kvinne = kvinneTot, sivil = giftTot, off = offTot, kom = komTot)

## ## Andel svarte Ja OFF_HJEL og KOMPAREN
## Tot02na <- DataT02[, lapply(.SD, function(x) tabulate(x) / .N * 100), .SDcol = c(v.offhjelp, v.komparen) ] #inkludert NA

tabell02 <- cbind(tot01, tot02) #NA eksludert i Totallen
tabell02$Navn <- "Total"
## Reorganisere
tabell02 <- tabell02[, list(Navn, alder, kvinne, edu, sivil, off, kom)]

## bytt navn
colnames(tabell02) <- col.name

#######################
## Klargjøre tabellen
######################
## Kombinere tabell med colnames data.table::rbindlist
## kobinere med total
tab.all <- rbindlist(list(tabell01, tabell02), fill = TRUE)

## Naming table
colAll <- c("Senter","År, mean", "Kvinne, %", "År, mean", "Gift/samboer, %", "Ja, %", "Ja, %")
colnames(tab.all) <- colAll

## siste linje til bold i pdf output
lastLine <- dim(tab.all)[1]


kable(tab.all, format = "latex", booktabs = TRUE, digits = c(0,1, 1, 1, 1, 1, 1)) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  row_spec(lastLine, bold = TRUE) %>%
  add_header_above(c("",
                     "Alder" = 1,
                     "Kjønn" = 1,
                     "Utdannelse" = 1,
                     "Sivil status" = 1,
                     "Offentlig Hjelp" = 1,
                     "Komparent" = 1))

## knitr::kable(tab03all) 

```

Missing data i de respektive analysene er som følgende:

```{r tabMis, echo=FALSE, warning=FALSE, message=FALSE}

#################
### Missing
################
tabellNA <- DataT02[, lapply(.SD, function(x) sum(is.na(x))), .SDcols = c("alder", "kjonn", "skoleyr", "sivil", v.offhjelp, v.komparen)]
## rename
setnames(tabellNA, c("kjonn", "skoleyr", "OFF_HJEL", "KOMPAREN"), c("kvinne", "edu", "off", "kom"))
tabellNA$Navn <- "Missing"

##reorganisere
tabellNA <- tabellNA[, list(Navn, alder, kvinne, edu, sivil, off, kom)]
colnames(tabellNA) <- c("", "Alder", "Kjønn", "Utdannelse", "Sivil status", "Offentlig Hjelp", "Komparent")


## Kobinere missing
tab.allm <- rbindlist(list(tab.all, tabellNA), fill = TRUE)

## ## Kombinere tabell med colnames data.table::rbindlist
## tab03all <- rbindlist(list(tab03, tab03tot), fill = TRUE)
## ## Kombinere tabell missing
## tab03allmiss <- rbindlist(list(tab03all, missTab), fill = TRUE)
## lineMiss <- dim(tab03allmiss)[1]
## tab03miss <- tab03allmiss[lineMiss, ]
## colMiss <- c("Data", "Alder", "Utdannelse", "Oftenlig Hjelp", "Komparent")
## colnames(tab03miss) <- colMiss


kable(tabellNA, booktabs = TRUE) %>%
  kable_styling(full_width = TRUE)

```

\pagebreak

# Motakker av offentlig hjelp


```{r fig02data, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}    

## Dataset med senter mer enn 20 (>20)
offPro <- DataT02[, .N, by = .(yr, get(v.offhjelp))]
bNA(offPro, 99)

offPro <- offPro[yr != 99]
setkey(offPro, yr)
offPro[, sum := sum(N), by = yr]
offPro[, pros := N / sum * 100, by = .(yr, get)][]


```                                           

Andel motakker av offentlig hjelp.

```{r figOffentlig, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
##labelling
fig_lab <- c("Nei", "Ja", "Ingen info")
offPro$get <- factor(offPro$get, levels = c(0,1,99),labels = fig_lab )

## Value prosent when max "yr" by "get"
setkey(offPro, yr)


gg.fig02 <- ggplot(offPro, aes(as.factor(yr), pros, group = get)) +
  geom_line(aes(color = as.factor(get)), size = 0.4) +
  geom_point(aes(shape = as.factor(get), color = as.factor(get)), stat = "identity") +
  scale_x_discrete(expand=c(0, 1.5)) +
  geom_text(aes(label = format(pros, digits = 1)), vjust = -0.6, color = "grey50", size = 2.8) +
  ## dl.trans for å posisjonere hvor teksten skal vises
  directlabels::geom_dl(aes(label = get), method = list(dl.trans(x = x + 0.5), "last.points", cex = 0.7)) +
  ggplot2::scale_color_manual(values = cols) + 
  theme_bw() +
  labs(title = "Andel motakker av offentlig hjelp", y = "prosent", x = "") + 
  theme(
    legend.position = "none",
    plot.title = element_text(size = 10, color = "black"),
    plot.margin = unit(c(0,2,0.5,0.5), "cm"),
    axis.text.y = element_text(size = 9, color = "black"),
    axis.ticks.y = element_blank(),
    axis.line.x = element_line(size = 0.5),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.y = element_text(size = 9),
    axis.title.x = element_text(size = 9)
  )

gg.fig02T <- ggplot_gtable(ggplot_build(gg.fig02))
gg.fig02T$layout$clip[gg.fig02T$layout$name == "panel"] <- "off"
grid.draw(gg.fig02T)

```

# Diagnoser

```{r figDiagnose, echo=FALSE, warning=FALSE, message=FALSE, fig.aline='center'}

v.diagnose <- "HOVEDDIAGNOSE"
setnames(DataT02, v.diagnose, "diag") #rename til diag

## diagnoser navn
diagVal01 <- c("SCI", "MCI", "AD", "VaD", "DLB/PDD/FTD", "Uspesifisert demens", "Annen diagnose")

diagVal02 <- c("Subjectiv kognitiv svikt",
               "Mild kognitiv svikt",
               "Demens av Alzheimerstype",
               "Vaskulær Demens",
               "DLB/PDD/FTD",
               "Uspesifisert demens",
               "Annen diagnose")

n.diag <- DataT02[, .N, by = .(diag)][is.na(diag), diag := 9] #NA =9
diagNA <- n.diag$N[n.diag$diag == 9] #antall missing


diag.tab <- n.diag[diag != 9, ]
diagN <- diag.tab[, sum(N)] #antall inkludert
diag.tab[, prop := N / diagN * 100] #beregn andel
diag.tab[.(diag = 0:6, to = diagVal02), on = "diag", diagose := i.to]
diag.tab[, prop := round(prop, digits = 1)]

txtCut <- diag.tab[, max(prop)]
diag.tab[, pos := ifelse(prop < 0.2 * txtCut, 0, 1)]

title <- "Diagnoser NorKog"
sub.title <- paste0("N = ", diagN, ", Antall missing = ", diagNA)
y.lab <- "Prosentvis andel"

position = position_dodge(width = .80)
width = .80

data.fig <- diag.tab

ggplot(data.fig, aes(reorder(diagose, prop), prop, label = prop)) +
  geom_bar(width = width, position = position, stat = "identity", fill = colb) +
  geom_text(data = data.fig[pos == 1], hjust = 1.3, size = 2.5) +
  geom_text(data = data.fig[pos == 0], hjust = -0.3, size = 2.5) +
  coord_flip() +
  labs(title = title, subtitle = sub.title, y = y.lab, x = "") +
  scale_y_continuous(expand = c(0, 0)) + 
  theme(
    plot.title = element_text(size = 10, color = "black"), 
    plot.margin = unit(c(0,2,0.5,0.5), "cm"),
    axis.text.y = element_text(size = 9, color = "black"),
    axis.ticks.y = element_blank(),
    axis.line.x = element_line(size = 0.5),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.y = element_text(size = 9),
    axis.title.x = element_text(size = 9),
    legend.position = "none")

```











