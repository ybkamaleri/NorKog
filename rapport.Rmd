---
title: "Rapport for NorKog"
output:
  pdf_document
date: '`r format(Sys.Date(), "%d %b %Y")`'
---

```{r dataValg, echo=FALSE}
rm(list = ls())

########################
## Valgfrie variabler ##
########################

## Hvilket år skal kombineres? - endres etter behov
yearMix <- 2008:2014

## deling for tekst posisjon i bar figur 1
deltxt <- 80

###################
## Variabler bruk


```




```{r file, echo=FALSE, warnings=FALSE, include=FALSE, message=FALSE}

## henter pakker eller installere om ikke finnes
inspak <- function(pkg){
  nypkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(nypkg))
    install.packages(nypkg, dependencies = TRUE, repos = "http://cran.r-project.org")
}

pakke <- c("data.table", "ggplot2", "directlabels", "grid", "knitr", "kableExtra", "haven")
inspak(pakke)

## Upload libraries
library(data.table)
library(ggplot2)
library(directlabels)
library(knitr)
library(grid)
library(kableExtra)
library(haven) #for å lese .sav fil

############
############
## DATA
filDir <- getwd()
sr01 <- paste0(filDir,"/", "datakilder1.R")
sr02 <- paste0(filDir, "/", "datakilder2.R")
##ifelse(file.exists(sr01), source(sr01), source(sr02))
data <- ifelse(file.exists(sr01), sr01, sr02)
source(data)

#############
## Knitr opt
#############

knitr::opts_chunk$set(fig.path = 'figures/nkog-') #mappe for figurer


###########
## FARGER
###########
ColPoint <- "#FF3333" #farge for point
cols <- c("#C6DBEF", "#4292C6", "#084594") #farge for flere bar
colb <- "#99CCFF" #farge for en søyle
options(digits = 3)
setDT(RegData)
setkey(RegData, SENTER)

###########
## Function
###########

## bytt NA med 0
bNA <- function(DT, na = 0){
  for (j in seq_len(ncol(DT)))
    set(DT,which(is.na(DT[[j]])),j, na) 
}


```

# Antall inkluderte per poliklinikk

```{r fig01data, echo=FALSE, message=FALSE, warning=FALSE}

## Lister av navn for sentrene
sentfil <- paste0(filDir, "/doc/senter.csv")
senter <- data.table::fread(sentfil, header = TRUE, encoding = "Latin-1")
setkey(senter, Senter) #key er senter kode

## Slå sammen senternavn og dataset
Data <- merge(RegData, senter, by.x = "SENTER", by.y = "Senter", all.x = TRUE)
fig00Data <- Data[, .N, by = Navn]


sn <- dim(senter)[1] #antall sentre
NN <- dim(RegData)[1] #antall pasienter i datasettet

## Merge
missn <- fig00Data[is.na(N), .N] #antall senter med misssing data
fig01Data <- fig00Data[is.na(N), N := 0]

inkn <- sn - missn #antall senter uten missing data
inkl <- Data[, length(unique(Navn))]

```

Det er `r inkl` poliklinikker inkludert i analysen. [*Her kan det ligge mer tekst om det er ønkelig*]

```{r fig01, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
## Legge til gjennomsnitt
DTsnitt <- data.table(Navn = "Gjennomsnitt", N = NN / sn)
fig02Data <- rbindlist(list(fig01Data, DTsnitt)) #kombinere gjennomsnitt til datasett

innText <- fig02Data[, pos := ifelse(N < deltxt, 0, 1)]
title <- paste0("Antall inkluderte per senter (N = ", NN, ")")
position = position_dodge(width = .80)
width = .80

ggplot(innText, aes(reorder(Navn, N), N, label = N)) +
  geom_bar(width = width, position = position, stat = "identity", aes(fill = Navn == 'Gjennomsnitt')) +
  geom_text(data = innText[pos == 1], hjust = 1.5, size = 2.5) +
  geom_text(data = innText[pos == 0],, hjust = -0.5, size = 2.5) +
  coord_flip() +
  labs(title = title, y = "", x = "") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = cols) + 
  theme(
    plot.title = element_text(size = 10, color = "black"), 
    plot.margin = unit(c(0,2,0.5,0.5), "cm"),
    axis.text.y = element_text(size = 9, color = "black"),
    axis.ticks.y = element_blank(),
    axis.line.x = element_line(size = 0.5),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.y = element_text(size = 9),
    axis.title.x = element_text(size = 9),
    legend.position = "none")

## gg.fig01T <- ggplot_gtable(ggplot_build(gg.fig1))
## gg.fig01T$layout$clip[gg.fig01T$layout$name == "panel"] <- "off"
## grid.draw(gg.fig01T)
```

\pagebreak


# Antall inkluderte per poliklinikk per år

```{r tab01data, echo=FALSE, message=FALSE, warning=FALSE}
## ## Fra først data sett
## Data <- Data[, date_us := as.IDate(DATO_US, format = "%m/%d/%Y")] #konvertere DATO_US til date.format
## Data[, yr := as.integer(format(date_us, "%Y"))] #lage kolone "yr" for år fra DATO_US
## yrNA <- Data[is.na(yr), .N] # Antall DATO_US == NA

#### Gir nytt variablenavn
############################
## yr <- "US_AARSTALL"
## Data[, yr := get(yr)]

yr <- quote(US_AARSTALL)
Data[, yr := eval(yr)]

yrNA <- Data[is.na(yr), .N]


###############################
## Slå sammen år til en kolone
###############################
yrmix <- yearMix #slå sammen disse år tallene
yrtab <- paste0(min(yearMix),"-", max(yearMix)) #tekst til tabell
Data[, yr2 := ifelse(yr %in% yrmix, 2000, yr)] #dummy for 2008:2012 er 2000

## Dataset uten NA i DATO_US
Datayr <- Data[, .SD[!is.na(yr)]] #exclude DATO_US == NA

```

Det er `r yrNA` missing data i **US_AARSTALL**. Derfor antallet er ikke lik som i forrige figur

```{r tab01, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

## Antall per senter per år
senNyrNA <- Datayr[, .N, by = .(Navn, yr2)]
names(senNyrNA)[names(senNyrNA) == "N"] <- "n"
senNyr1 <- dcast(senNyrNA, Navn ~ yr2, value.var = "n")

bNA(DT = senNyr1, na = 0) #bytt all NA til 0

## Antall total per senter
senN <- Datayr[, .N, by = .(Navn)]
names(senN)[names(senN) == "N"] <- "Total"

## Kobinere antall per senter og total
tab02 <- merge(senNyr1, senN, by="Navn")

## Antall per år
yearN <- Datayr[, .N, by = .(yr2)]
yearN$Navn <- "Total"
yearN1 <- dcast(yearN, Navn ~ yr2, value.var = "N")
yearN1$Total <- dim(Datayr)[1]

## Tabell
tab02all <- rbind(tab02, yearN1)
names(tab02all)[names(tab02all) == 2000] <- yrtab #gi col navn
names(tab02all)[names(tab02all) == "Navn"] <- "Poliklinikk" #col navn Senter

## print tabell
rowspec <- dim(tab02all)[1]
kable(tab02all, format = "latex", booktabs = TRUE) %>%
  kable_styling(latex_options = c("repeat_header", "hold_position")) %>%
  row_spec(rowspec, bold = TRUE) 

## knitr::kable(tab02all)

```

\pagebreak


# Demografiske variabler, gjennomsnitt per poliklinikk og missing

Mangler [kodebok] for **Kjønn** og **Sivil status** i dokumentet.

**OBS!** Alle senter med deltaker <20 er eksludert i alle analysene herfra. 

```{r tab02data, echo=FALSE, message=FALSE, warning=FALSE}

## eksludert senter med mindre enn 20
valgSenter <- senN$Navn[senN$Total > 20] #vector Senter navn med deltaker >20

DataT02 <- Data[Navn %in% valgSenter, ]
setkey(DataT02, Navn)

#OBS! kan lage problem med norske bokstave

## ## Alder beregn fra år hentes fra DATO_US
## ## rename FØDSELSÅ to "byear" 

## vb01 <- grep("DSELS", colnames(DataT02), fixed = TRUE)#finne index for FØDSELSÅ
## colnames(DataT02)[vb01] <- "byear"
## DataT02[, alder := yr - byear] 
## DataT02[, alder := ifelse(is.na(alder), ALDER_PAS, alder)]
## ageT02 <- DataT02[, mean(alder, na.rm = TRUE), by = Navn]
## names(ageT02)[names(ageT02) == "V1"] <- "Alder"
## ## ageTot <- DataT02[, mean(alder, na.rm = TRUE)] #total mean alder


vb01 <- "ALDER"
DataT02[, alder := get(vb01)]
ageT02 <- DataT02[, list(Alder = mean(as.numeric(get(vb01)), na.rm = TRUE)), by = Navn]


## Kjønn - andel per senter
vb03 <- grep("KJONN", colnames(DataT02))

colnames(DataT02)[vb03] <- "kjonn"
kjonnval <- c("Kvinne", "Mann")
DataT02$kjonn <- factor(DataT02$kjonn,
                        levels = c(0, 1),
                        labels = kjonnval)

vb03mk <- DataT02[, .N, by = Navn] # antall per poliklinikk
vb03k <- DataT02[kjonn == "Kvinne", .N, by = Navn] # antall kvinner
names(vb03k)[2] <- "n"
setkey(vb03mk, Navn)
setkey(vb03k, Navn)
kvinne <- vb03k[vb03mk]
kvinne[, kvinne := n / N * 100, by = Navn]
kvinneT03 <- kvinne[, c(1, 4)]


## Sivil status
sivil01 <- "SIVILSTA"
setnames(DataT02, sivil01, "sivil") #gir nytt navn

sivil02na <- DataT02[!is.na(sivil), .N, by = Navn]
sivil02ja <- DataT02[sivil == 1, .N, by = Navn]
setnames(sivil02ja, "N", "n")

setkey(sivil02na, Navn)
setkey(sivil02ja, Navn)

sivil02per <- sivil02ja[sivil02na]
sivil02per[, sivil := n / N * 100, by = Navn]
sivil02all <- sivil02per[, c(1, 4)]



## Utdannelse
## Bytt ÅR_SKOLE til "skoleyr"
vb02 <- grep("SKOLEGANG", colnames(DataT02))#finne index for ÅR_SKOLE
colnames(DataT02)[vb02] <- "skoleyr"
DataT02[, skole := as.numeric(skoleyr)]
skoT02 <- DataT02[, mean(skole, na.rm = TRUE), by = Navn]
names(skoT02)[names(skoT02) == "V1"] <- "Utdannelse"
## skoTot <- DataT02[, mean(skole, na.rm = TRUE)] #total utdannelse år

## Offentlig hjelp NA remove
## Skal NA tatt bort eller bregn som nevner???
##proOffTab <- DataT02[order(OFF_HJEL), list(unique(OFF_HJEL), proHjel = tabulate(OFF_HJEL) / .N + 100), by = Navn]
v04 <- "OFF_HJEL"
v04na <- DataT02[!is.na(get(v04)), .N, by = Navn]
v04ja <- DataT02[get(v04) == 1, .N, by = Navn]
colnames(v04ja) <- c("Navn", "n")
setkey(v04na, Navn)
setkey(v04ja, Navn)
offT02Tab <- v04na[v04ja]
offT02Tab[, off := n / N * 100, by = Navn]
offT02 <- offT02Tab[, c(1, 4)]

## offT02Tab <- DataT02[order(get(v04)), list(unique(get(v04)), V2 = tabulate(get(v04)) / .N * 100), by = Navn]
## offT02 <- offT02Tab[V1 == 1] #NA inkludert som nevner
## offT02$V1 <- NULL
## names(offT02)[names(offT02) == "V2"] <- "Offentlig"
## ## total offentlig hjelp
## offTotValue <- DataT02[order(get(v04)), list(unique(get(v04)), V2 = tabulate(get(v04)) / .N * 100)]
## offTot <- offTotValue$V2[offTotValue$V1 == 1][1]

## Komparent NA remove
v05 <- "KOMPAREN"
v05na <- DataT02[!is.na(get(v05)), .N, by = Navn]
v05ja <- DataT02[get(v05) == 1, .N, by = Navn]
colnames(v05ja) <- c("Navn", "n")
setkey(v05na, Navn)
setkey(v05ja, Navn)
komT02Tab <- v05na[v05ja]
komT02Tab[, kom := n / N * 100, by = Navn]
komT02 <- komT02Tab[, c(1, 4)]


## komT02Tab <- DataT02[order(get(v05)), list(unique(get(v05)), V2 = tabulate(get(v05)) / .N * 100), by = Navn]
## komT02 <- komT02Tab[V1 == 1]
## komT02$V1 <- NULL
## names(komT02)[names(komT02) == "V2"] <- "Komparent"
## ## total komparent
## komTotValue <- DataT02[order(get(v05)), list(unique(get(v05)), V2 = tabulate(get(v05)) / .N * 100)]
## komTot <- komTotValue$V2[komTotValue$V1 == 1][1]

##############
### TOTAL
##############

## Mean alder og utdannelse Total
Tot01 <-  DataT02[, lapply(.SD, function(x) mean(x, na.rm = T)), .SDcol = c("alder", "skole")]


## Andel kvinner
totK <- DataT02[kjonn == "Kvinne", .N]
totAlle <- dim(DataT02)[1]
TotKvinner <- totK / totAlle * 100

## Andel gift/samboer
sivilNA <- DataT02[!is.na(sivil), .N]




## Andel svarte Ja OFF_HJEL eksludert NA
offNA <- DataT02[!is.na(get(v04)), .N] #OFF_HJEL uten NA
totOff <- DataT02[, lapply(.SD, function(x) tabulate(x) / offNA * 100), .SDcol = c(v04)] #uten NA OFF_HJEL

## enkle løsning
off01 <- DataT02[get(v04) == 1, .N]
totOff01 <- off01 / offNA * 100

## Andel svarte Ja KOMPAREN eksludert NA
komNA <- DataT02[!is.na(get(v05)), .N] #KOMPAREN uten NA
totKom <- DataT02[, lapply(.SD, function(x) tabulate(x) / komNA * 100), .SDcol = c(v05)] #uten NA OFF_HJEL

tot01 <- DataT02[get(v05) == 1, .N]
totKom01 <- tot01 / komNA * 100

Tot022 <- data.table(off = totOff01, kom = totKom01)

Tot02 <- cbind(totOff, totKom)


## Andel svarte Ja OFF_HJEL og KOMPAREN
Tot02na <- DataT02[, lapply(.SD, function(x) tabulate(x) / .N * 100), .SDcol = c(v04, v05) ] #inkludert NA


colTot <- c("age", "edu", "off", "kom")
tab03tot <- cbind(Tot01, Tot02) #NA eksludert i Totallen
colnames(tab03tot) <- colTot
tab03tot$Senter <- "Total"

## colTot <- colnames(tab03)
## varN <- list(ageTot, skoTot, offTot, komTot)
## valTot <- c("Total", ageTot, skoTot, offTot, komTot)
## tabTot <- data.table(colTot, valTot)

col3 <- c("Senter", "age", "edu", "off", "kom")

listTab <- list(ageT02, skoT02, offT02, komT02)
tab03 <- Reduce(function(x, y) x[y], listTab)

## Endre col navn
colnames(tab03) <- col3

### Missing
missTab <- DataT02[, lapply(.SD, function(x) sum(is.na(x))), .SDcols = c("alder", "skole", v04, v05)]
colnames(missTab) <- colTot
missTab$Senter <- "Missing"

## Kombinere tabell med colnames data.table::rbindlist
tab03all <- rbindlist(list(tab03, tab03tot), fill = TRUE)
## Kombinere tabell missing
tab03allmiss <- rbindlist(list(tab03all, missTab), fill = TRUE)
lineMiss <- dim(tab03allmiss)[1]
tab03miss <- tab03allmiss[lineMiss, ]
colMiss <- c("Data", "Alder", "Utdannelse", "Oftenlig Hjelp", "Komparent")
colnames(tab03miss) <- colMiss

## Naming table
colAll <- c("Senter", "År, mean", "År, mean", "Ja, %", "Ja, %")
colnames(tab03all) <- colAll

## siste linje til bold i pdf output
lastLine <- dim(tab03all)[1]


kable(tab03all, format = "latex", booktabs = TRUE, digits = c(0,1, 1, 0, 0)) %>%
                     kable_styling(latex_options = c("hold_position")) %>%
                     row_spec(lastLine, bold = TRUE) %>%
                     add_header_above(c("", "Alder" = 1, "Utdannelse" = 1, "Offentlig Hjelp" = 1,
                                        "Komparent" = 1))

                   ## knitr::kable(tab03all) 

```

Alle missing er eksludert i analysen. De er som følgende:

```{r tabMis, echo=FALSE, warning=FALSE, message=FALSE}
kable(tab03miss, booktabs = TRUE)

```

\pagebreak

# Motakker av offentlig hjelp


```{r fig02data, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}    

## Dataset med senter mer enn 20 (>20)
offPro <- DataT02[, .N, by = .(yr, get(v04))]
bNA(offPro, 99)

offPro <- offPro[yr != 99]
setkey(offPro, yr)
offPro[, sum := sum(N), by = yr]
offPro[, pros := N / sum * 100, by = .(yr, get)][]


```                                           

Andel motakker av offentlig hjelp. [*Jeg synes å presentere dataene som linje diagram belyser tydeligere tidstrend i dataene. Det er vanskeligere å se trend for de forskjellige kategoriene i stack diagram som foreslått*]


```{r fig02, echo=FALSE, warning=FALSE, message=FALSE, fig.height=3.5, fig.width=6,fig.align='center'}
##labelling
fig_lab <- c("Nei", "Ja", "Ingen info")
offPro$get <- factor(offPro$get, levels = c(0,1,99),labels = fig_lab )

## Value prosent when max "yr" by "get"
setkey(offPro, yr)


gg.fig02 <- ggplot(offPro, aes(as.factor(yr), pros, group = get)) +
  geom_line(aes(color = as.factor(get)), size = 0.4) +
  geom_point(aes(shape = as.factor(get), color = as.factor(get)), stat = "identity") +
  scale_x_discrete(expand=c(0, 1.5)) +
  geom_text(aes(label = format(pros, digits = 1)), vjust = -0.6, color = "grey50", size = 2.8) +
  ## dl.trans for å posisjonere hvor teksten skal vises
  directlabels::geom_dl(aes(label = get), method = list(dl.trans(x = x + 0.5), "last.points", cex = 0.7)) +
  ggplot2::scale_color_manual(values = cols) + 
  theme_bw() +
  labs(title = "Andel motakker av offentlig hjelp", y = "prosent", x = "") + 
  theme(
    legend.position = "none",
    plot.title = element_text(size = 10, color = "black"),
    plot.margin = unit(c(0,2,0.5,0.5), "cm"),
    axis.text.y = element_text(size = 9, color = "black"),
    axis.ticks.y = element_blank(),
    axis.line.x = element_line(size = 0.5),
    panel.background = element_blank(),
    panel.border = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.y = element_text(size = 9),
    axis.title.x = element_text(size = 9)
  )

gg.fig02T <- ggplot_gtable(ggplot_build(gg.fig02))
gg.fig02T$layout$clip[gg.fig02T$layout$name == "panel"] <- "off"
grid.draw(gg.fig02T)

```

# Gjennomsnitt alder, per senter per år

Her bør nok tenke om igjen hva vil dere fortelle i figuren. 










